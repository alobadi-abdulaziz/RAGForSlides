<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study with Me - RAG Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        
        .chat-bubble-user, .chat-bubble-assistant {
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .chat-bubble-assistant.prose pre {
            white-space: pre-wrap; /* Ensures code blocks wrap */
        }

        .chat-bubble-user { background-color: #3b82f6; color: white; border-radius: 20px 20px 5px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chat-bubble-assistant { background-color: #ffffff; color: #1f2937; border-radius: 20px 5px 20px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chat-bubble-assistant.ltr-text { direction: ltr; text-align: left; }
        .chat-bubble-assistant.prose.ltr-text,
        .chat-bubble-assistant.prose.ltr-text :where(p, ol, ul, li) { text-align: left; }
        .chat-bubble-assistant.ltr-text ol, .chat-bubble-assistant.ltr-text ul { padding-right: 0; padding-left: 20px; }
        .chat-bubble-assistant strong { font-weight: 700; color: #111827; }
        .chat-bubble-assistant p { margin-top: 0; margin-bottom: 0.5rem; }
        .chat-bubble-assistant ol, .chat-bubble-assistant ul { padding-right: 20px; padding-left: 0; margin-bottom: 0.5rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        .scroll-smooth { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f8fafc; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        .typing-indicator span {
            height: 8px; width: 8px; background-color: #94a3b8;
            border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = "http://127.0.0.1:8000";
        
        const apiCall = async (endpoint, method = 'GET', body = null, token = null) => {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                throw new Error(errorData.detail || 'An error occurred');
            }
            return response.status !== 204 ? await response.json() : null;
        };

        const AuthForm = ({ onAuthSuccess }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [email, setEmail] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setIsLoading(true);

                try {
                    if (isLogin) {
                        const formData = new URLSearchParams();
                        formData.append('username', username);
                        formData.append('password', password);

                        const response = await fetch(`${API_URL}/users/token`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: formData,
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Login failed');
                        }
                        const data = await response.json();
                        onAuthSuccess(data.access_token);
                    } else {
                        await apiCall('/users/register', 'POST', { username, email, password });
                        setSuccess('تم التسجيل بنجاح! يرجى التحقق من بريدك الإلكتروني لتفعيل حسابك.');
                        setIsLogin(true);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                    <div dir="rtl" className="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                        <div className="flex justify-center mb-6">
                             <svg className="w-16 h-16 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                            </svg>
                        </div>
                        <h2 className="text-3xl font-bold text-center text-gray-800 mb-2">Study with Me</h2>
                        <p className="text-center text-gray-500 mb-6">{isLogin ? 'أهلاً بعودتك!' : 'انضم إلينا وابدأ رحلتك التعليمية'}</p>
                        
                        {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</div>}
                        {success && <div className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-sm">{success}</div>}
                        <form onSubmit={handleSubmit}>
                           {!isLogin && (
                                <div className="mb-4">
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">البريد الإلكتروني</label>
                                    <input type="email" id="email" value={email} onChange={(e) => setEmail(e.target.value)} className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" required />
                                </div>
                            )}
                            <div className="mb-4">
                               <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">اسم المستخدم</label>
                               <input type="text" id="username" value={username} onChange={(e) => setUsername(e.target.value)} className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">كلمة المرور</label>
                                <input type="password" id="password" value={password} onChange={(e) => setPassword(e.target.value)} className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" required />
                            </div>
                            <div className="flex flex-col gap-4">
                                <button type="submit" disabled={isLoading} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors disabled:bg-blue-300">
                                    {isLoading ? 'جار التحميل...' : (isLogin ? 'تسجيل الدخول' : 'إنشاء حساب')}
                                </button>
                                <button type="button" onClick={(e) => { e.preventDefault(); setIsLogin(!isLogin); setError(''); setSuccess(''); }} className="w-full text-center font-bold text-sm text-blue-500 hover:text-blue-700">
                                    {isLogin ? 'ليس لديك حساب؟ سجل الآن' : 'هل لديك حساب بالفعل؟'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, onCancel, onConfirm, title, message }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div dir="rtl" className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end space-x-reverse space-x-3">
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">إلغاء</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">تأكيد الحذف</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ChatInterface = ({ token, onLogout }) => {
            const [conversations, setConversations] = useState([]);
            const [activeConversationId, setActiveConversationId] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [editingConvId, setEditingConvId] = useState(null);
            const [editingTitle, setEditingTitle] = useState("");
            const [deletingConv, setDeletingConv] = useState(null);

            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); };

            const fetchConversations = async () => {
                try {
                    const data = await apiCall('/chat/conversations', 'GET', null, token);
                    setConversations(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                } catch (error) {
                    console.error('Failed to fetch conversations:', error);
                }
            };
            
            const fetchCurrentUser = async () => {
                 try {
                    const user = await apiCall('/users/me', 'GET', null, token);
                    setCurrentUser(user);
                } catch (error) {
                    console.error('Failed to fetch user:', error);
                    onLogout();
                }
            };

            useEffect(() => { if (token) { fetchCurrentUser(); fetchConversations(); } }, [token]);
            useEffect(scrollToBottom, [messages]);
            
            const selectConversation = async (id) => {
                if (isLoading) return;
                setActiveConversationId(id);
                setEditingConvId(null);
                try {
                    setIsLoading(true);
                    const data = await apiCall(`/chat/conversations/${id}`, 'GET', null, token);
                    setMessages(data.messages);
                } catch (error) {
                    console.error('Failed to fetch messages:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleNewConversation = async () => {
                if(isLoading) return;
                try {
                    const newConv = await apiCall('/chat/conversations', 'POST', {}, token);
                    setConversations(prev => [newConv, ...prev.sort((a,b) => new Date(b.created_at) - new Date(a.created_at))]);
                    selectConversation(newConv.id);
                } catch (error) {
                    console.error('Failed to create new conversation:', error);
                }
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !activeConversationId || isLoading) return;

                const userMessage = { id: `user-${Date.now()}`, content: newMessage, role: 'user' };
                const assistantPlaceholderId = `assistant-${Date.now()}`;
                
                setMessages(prev => [...prev, userMessage, { id: assistantPlaceholderId, content: "", role: 'assistant' }]);
                setNewMessage('');
                setIsLoading(true);

                try {
                    const response = await fetch(`${API_URL}/chat/conversations/${activeConversationId}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ content: newMessage, role: 'user' }),
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        setMessages(prev => 
                            prev.map(msg => 
                                msg.id === assistantPlaceholderId 
                                    ? { ...msg, content: msg.content + chunk } 
                                    : msg
                            )
                        );
                    }
                } catch (error) {
                    console.error("Failed to send message:", error);
                     setMessages(prev => 
                        prev.map(msg => 
                            msg.id === assistantPlaceholderId 
                                ? { ...msg, content: "حدث خطأ أثناء الاتصال بالخادم." } 
                                : msg
                        )
                    );
                } finally {
                    setIsLoading(false);
                    fetchConversations();
                }
            };

            const handleStartRename = (conv) => {
                setEditingConvId(conv.id);
                setEditingTitle(conv.title);
            };
            
            const handleCancelRename = () => {
                setEditingConvId(null);
                setEditingTitle("");
            };

            const handleConfirmRename = async (e) => {
                e.preventDefault();
                if (!editingTitle.trim() || !editingConvId) {
                    handleCancelRename();
                    return;
                }
                try {
                    const updatedConv = await apiCall(
                        `/chat/conversations/${editingConvId}`,
                        'PUT',
                        { title: editingTitle },
                        token
                    );
                    setConversations(prev => prev.map(c => c.id === editingConvId ? updatedConv : c));
                    handleCancelRename();
                } catch (error) {
                    console.error("Failed to rename conversation", error);
                }
            };
            
            const handleDeleteRequest = (conv) => {
                setDeletingConv(conv);
            };

            const handleConfirmDelete = async () => {
                if (!deletingConv) return;
                try {
                    await apiCall(`/chat/conversations/${deletingConv.id}`, 'DELETE', null, token);
                    setConversations(prev => prev.filter(c => c.id !== deletingConv.id));
                    if (activeConversationId === deletingConv.id) {
                        setActiveConversationId(null);
                        setMessages([]);
                    }
                    setDeletingConv(null);
                } catch (error) {
                     console.error("Failed to delete conversation", error);
                }
            };
            
            const isLtr = (text) => {
                if (!text) return false;
                const ltrRegex = /^[A-Za-z0-9!"#$%&'()*+,-.\/:;<=>?@[\\\]^_`{|}~]/;
                return ltrRegex.test(text);
            }

            return (
                <div className="flex h-screen bg-slate-50 text-gray-800">
                    <ConfirmationModal isOpen={!!deletingConv} onCancel={() => setDeletingConv(null)} onConfirm={handleConfirmDelete} title="تأكيد الحذف" message={`هل أنت متأكد أنك تريد حذف محادثة "${deletingConv?.title}"؟ لا يمكن التراجع عن هذا الإجراء.`}/>

                    <aside dir="rtl" className="w-80 bg-white border-r border-gray-200 flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <svg className="w-8 h-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                <h2 className="text-xl font-bold">Study with Me</h2>
                            </div>
                            <button onClick={handleNewConversation} className="p-2 rounded-lg hover:bg-gray-200 transition-colors" title="محادثة جديدة"><i className="fas fa-plus text-gray-600"></i></button>
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            {conversations.map(conv => (
                                <div key={conv.id} className={`m-2 p-3 cursor-pointer rounded-lg border-l-4 group ${activeConversationId === conv.id ? 'bg-blue-50 border-blue-500' : 'hover:bg-gray-100 border-transparent'}`} onClick={() => editingConvId !== conv.id && selectConversation(conv.id)}>
                                    {editingConvId === conv.id ? ( <form onSubmit={handleConfirmRename}> <input type="text" value={editingTitle} onChange={(e) => setEditingTitle(e.target.value)} onBlur={handleConfirmRename} className="w-full p-1 border rounded text-sm" autoFocus onClick={e => e.stopPropagation()}/> </form> ) : (
                                        <div className="flex justify-between items-center">
                                            <p className="font-semibold text-gray-700 truncate">{conv.title}</p>
                                            <div className="opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                                                <button onClick={(e) => {e.stopPropagation(); handleStartRename(conv)}} className="p-1 text-gray-500 hover:text-blue-600 ml-1"><i className="fas fa-pen fa-xs"></i></button>
                                                <button onClick={(e) => {e.stopPropagation(); handleDeleteRequest(conv)}} className="p-1 text-gray-500 hover:text-red-600"><i className="fas fa-trash fa-xs"></i></button>
                                            </div>
                                        </div>
                                    )}
                                    <p className="text-sm text-gray-500 mt-1">{new Date(conv.created_at).toLocaleDateString('ar-EG')}</p>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t flex items-center justify-between bg-white">
                             <div className="text-gray-700 flex items-center gap-2">
                                <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">{currentUser?.username?.charAt(0).toUpperCase()}</div>
                                {currentUser && <p className="font-semibold">{currentUser.username}</p>}
                             </div>
                             <button onClick={onLogout} className="p-2 rounded-lg hover:bg-red-100 text-red-600 transition-colors" title="تسجيل الخروج"><i className="fas fa-sign-out-alt"></i></button>
                         </div>
                    </aside>

                    <main className="flex-1 flex flex-col">
                        {activeConversationId ? (
                            <>
                                <div dir="rtl" className="flex-1 p-6 overflow-y-auto scroll-smooth">
                                    {messages.map((msg, index) => {
                                        const messageClass = `max-w-3xl px-5 py-3 prose fade-in ${ msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant' } ${ msg.role === 'assistant' && isLtr(msg.content) ? 'ltr-text' : '' }`;
                                        return (
                                            <div key={msg.id || index} className={`flex my-2.5 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={messageClass} dangerouslySetInnerHTML={{ __html: msg.role === 'assistant' ? (msg.content ? marked.parse(msg.content) : '<div class="typing-indicator"><span></span><span></span><span></span></div>') : msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;") }}/>
                                            </div>
                                        );
                                    })}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="p-4 bg-white border-t-2 border-slate-100">
                                     <form onSubmit={handleSendMessage} className="flex items-center gap-3" dir="rtl">
                                        <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder="اكتب رسالتك هنا..." className="flex-1 p-3 border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" disabled={isLoading}/>
                                        <button type="submit" className="p-3 w-12 h-12 bg-blue-500 text-white rounded-full disabled:bg-blue-300 transition-colors flex-shrink-0" disabled={isLoading || !newMessage.trim()}><i className="fas fa-paper-plane"></i></button>
                                    </form>
                                </div>
                            </>
                        ) : (
                            <div dir="rtl" className="flex-1 flex flex-col items-center justify-center text-center text-gray-500 p-8">
                                <div className="w-24 h-24 mb-4 text-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                </div>
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">Study with Me</h1>
                                <p className="text-lg text-gray-600">أهلاً بك! أنا هنا لمساعدتك في رحلتك التعليمية.</p>
                                <p className="mt-4 text-gray-500">ابدأ محادثة جديدة من <i className="fas fa-plus mx-1"></i> أو اختر واحدة سابقة للمتابعة.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        
        const App = () => {
            const [token, setToken] = useState(localStorage.getItem('rag_token'));

            const handleAuthSuccess = (newToken) => {
                localStorage.setItem('rag_token', newToken);
                setToken(newToken);
            };

            const handleLogout = () => {
                localStorage.removeItem('rag_token');
                setToken(null);
            };

            return token ? <ChatInterface token={token} onLogout={handleLogout} /> : <AuthForm onAuthSuccess={handleAuthSuccess} />;
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

